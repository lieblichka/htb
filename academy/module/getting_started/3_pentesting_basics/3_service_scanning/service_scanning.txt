*** Service Scanning
Сервисное сканирование 

	Мы готовы сделать еще один шаг и начать исследовать машину! Первое, что нам
	нужно сделать, это определить операционную систему и любые доступные службы,
	которые могут быть запущены. Служба — это приложение, работающее на
	компьютере, которое выполняет некоторую полезную функцию для других
	пользователей или компьютеров. Мы называем эти специализированные машины, на
	которых размещены эти полезные службы, «серверами», а не рабочими станциями,
	что позволяет пользователям взаимодействовать с этими различными службами и
	использовать их. Нас интересуют сервисы, которые либо неправильно настроены,
	либо имеют уязвимость. Вместо выполнения действий, ожидаемых как часть
	службы, нам интересно посмотреть, сможем ли мы заставить службу выполнить
	какое-то непреднамеренное действие, которое поддерживает наши цели,
	например, выполнить команду по нашему выбору.

	Компьютерам назначаются IP-адреса, что позволяет однозначно идентифицировать
	их и обеспечивать доступ в сети. Службам, работающим на этих компьютерах,
	может быть назначен номер порта, чтобы сделать службу доступной. Как
	обсуждалось ранее, номера портов находятся в диапазоне от 1 до 65 535, при
	этом диапазон общеизвестных портов от 1 до 1 023 зарезервирован для
	привилегированных служб. Порт 0 является зарезервированным портом в сети
	TCP/IP и не используется в сообщениях TCP или UDP. Если что-либо попытается
	привязаться к порту 0 (например, служба), оно будет привязано к следующему
	доступному порту после порта 1024, поскольку порт 0 рассматривается как порт
	с подстановочным знаком.

	Чтобы получить удаленный доступ к службе, нам нужно подключиться, используя
	правильный IP-адрес и номер порта, и использовать язык, понятный службе.
	Вручную проверять все 65 535 портов на наличие доступных служб было бы
	трудоемко, поэтому были созданы инструменты для автоматизации этого процесса
	и сканирования диапазона портов для нас. Одним из наиболее часто
	используемых инструментов сканирования является Nmap (Network Mapper).
	
	### Nmap
		
		Начнем с самого простого сканирования. Предположим, что мы хотим
		выполнить базовое сканирование цели, находящейся по адресу
		10.129.42.253. Для этого мы должны ввести nmap 10.129.42.253и нажмите
		возврат. Мы видим, что Nmapсканирование было выполнено очень быстро. Это
		связано с тем, что если мы не укажем никаких дополнительных параметров,
		Nmap по умолчанию будет сканировать только 1000 наиболее
		распространенных портов. Результат сканирования показывает, что доступны
		порты 21, 22, 80, 139 и 445.
			
			mwuckert@htb[/htb]$ nmap 10.129.42.253

			Starting Nmap 7.80 ( https://nmap.org ) at 2021-02-25 16:07 EST
			Nmap scan report for 10.129.42.253
			Host is up (0.11s latency).
			Not shown: 995 closed ports
			PORT    STATE SERVICE
			21/tcp  open  ftp
			22/tcp  open  ssh
			80/tcp  open  http
			139/tcp open  netbios-ssn
			445/tcp open  microsoft-ds

			Nmap done: 1 IP address (1 host up) scanned in 2.19 seconds

		Под PORTзаголовок, он также говорит нам, что это TCP-порты. По
		умолчанию, Nmapпроведет сканирование TCP, если специально не будет
		запрошено выполнение сканирования UDP.  STATEзаголовок подтверждает, что
		эти порты открыты. Иногда мы будем видеть другие перечисленные порты,
		которые имеют другое состояние, например filtered. Это может произойти,
		если брандмауэр разрешает доступ к портам только с определенных адресов.
		SERVICEзаголовок сообщает нам, что имя службы обычно сопоставляется с
		конкретным номером порта. Однако сканирование по умолчанию не скажет
		нам, что прослушивает этот порт. Пока мы не проинструктируем Nmapдля
		взаимодействия со службой и попытки получить идентифицирующую
		информацию, это может быть совсем другая служба.

		По мере знакомства мы заметим, что несколько портов обычно ассоциируются
		с Windows или Linux. Например, порт 3389 является портом по умолчанию
		для служб удаленных рабочих столов и является отличным показателем того,
		что целью является компьютер с Windows. В нашем текущем сценарии
		доступный порт 22 (SSH) указывает на то, что цель работает под
		управлением Linux/Unix, но эту службу также можно настроить в Windows.
		Давайте запустим более продвинутый Nmapсканирование и сбор
		дополнительной информации о целевом устройстве.

		Мы можем использовать -sCпараметр, чтобы указать, что Nmapследует
		использовать сценарии, чтобы попытаться получить более подробную
		информацию. -sVпараметр указывает Nmapдля проверки версии. При этом
		сканировании Nmap снимает отпечатки служб в целевой системе и определяет
		протокол службы, имя приложения и версию. Сканирование версий
		поддерживается обширной базой данных, содержащей более 1000 сигнатур
		служб. Окончательно, -p-сообщает Nmap, что мы хотим просканировать все
		65 535 портов TCP. 
			
			mwuckert@htb[/htb]$ nmap -sV -sC -p- 10.129.42.253

			Starting Nmap 7.80 ( https://nmap.org ) at 2021-02-25 16:18 EST
			Nmap scan report for 10.129.42.253
			Host is up (0.11s latency).
			Not shown: 65530 closed ports
			PORT    STATE SERVICE     VERSION
			21/tcp  open  ftp         vsftpd 3.0.3
			| ftp-anon: Anonymous FTP login allowed (FTP code 230)
			|_drwxr-xr-x    2 ftp      ftp          4096 Feb 25 19:25 pub
			| ftp-syst:
			|   STAT:
			| FTP server status:
			|      Connected to ::ffff:10.10.14.2
			|      Logged in as ftp
			|      TYPE: ASCII
			|      No session bandwidth limit
			|      Session timeout in seconds is 300
			|      Control connection is plain text
			|      Data connections will be plain text
			|      At session startup, client count was 2
			|      vsFTPd 3.0.3 - secure, fast, stable
			|_End of status
			22/tcp  open  ssh         OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 (Ubuntu Linux; protocol 2.0)
			80/tcp  open  http        Apache httpd 2.4.41 ((Ubuntu))
			|_http-server-header: Apache/2.4.41 (Ubuntu)
			|_http-title: PHP 7.4.3 - phpinfo()
			139/tcp open  netbios-ssn Samba smbd 4.6.2
			445/tcp open  netbios-ssn Samba smbd 4.6.2
			Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel

			Host script results:
			|_nbstat: NetBIOS name: GS-SVCSCAN, NetBIOS user: <unknown>, NetBIOS MAC: <unknown> (unknown)
			| smb2-security-mode:
			|   2.02:
			|_    Message signing enabled but not required
			| smb2-time:
			|   date: 2021-02-25T21:21:51
			|_  start_date: N/A

			Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
			Nmap done: 1 IP address (1 host up) scanned in 233.68 seconds

		Это возвращает гораздо больше информации. Мы видим, что сканирование 65
		535 портов заняло намного больше времени, чем 1000 портов. -sCа также
		-sVОпции также увеличивают продолжительность сканирования, так как
		вместо выполнения простого TCP-квитирования они выполняют намного больше
		проверок. Мы замечаем, что на этот раз есть заголовок VERSION, который
		сообщает версию службы и операционную систему, если это возможно
		определить.

		Пока что мы знаем, что операционная система — Ubuntu Linux. Версии
		приложений также могут помочь определить версию целевой ОС. Возьмем, к
		примеру, OpenSSH.  Мы видим, что заявленная версия OpenSSH 8.2p1 Ubuntu
		4ubuntu0.1. других пакетов Ubuntu SSH Изучая журналы изменений , мы
		видим, что релизная версия имеет формат 1:7.3p1-1ubuntu0.1. Обновляя
		нашу версию под этот формат, мы получаем 1:8.2p1-4ubuntu0.1. 
			
			https://launchpad.net/ubuntu/yakkety/+source/openssh/+changelog

		Быстрый поиск этой версии в Интернете показывает, что она включена в
		Ubuntu Linux Focal Fossa 20.04. 
			
			~~~___ LINK ___~~~ img/google1.png

		Еще один быстрый поиск показывает, что дата выпуска этой ОС — 23 апреля
		2020 года.
			
			~~~___ LINK ___~~~ img/google2.png

		Однако стоит отметить, что этот метод перекрестных ссылок не совсем
		надежен, так как можно установить более свежие пакеты приложений на
		более старую версию ОС. Сканирование сценария -sCфлаг причины
		Nmapсообщить заголовки сервера http-server-headerстраница и название
		страницы http-titleдля любой веб-страницы, размещенной на веб-сервере.
		Название веб-страницы PHP 7.4.3 - phpinfo()указывает, что это файл
		PHPInfo, который часто создается вручную для подтверждения успешной
		установки PHP. Заголовок (и страница PHPInfo) также показывает версию
		PHP, на которую стоит обратить внимание, если она уязвима.
			
			phpinfo.png


		# Nmap Scripts
		Скрипты Nmap 
			
			Указание -sCбудет запускать много полезных сценариев по умолчанию
			для цели, но бывают случаи, когда требуется запуск определенного
			сценария. Например, в рамках оценки нас могут попросить провести
			аудит большой установки Citrix. Мы могли бы использовать это
			Nmapскрипт для аудита серьезной уязвимости Citrix NetScaler (
			CVE-2019–19781 ), в то время как Nmapтакже имеет другие сценарии для
			аудита установки Citrix. 			
				
				https://raw.githubusercontent.com/cyberstruggle/DeltaGroup/master/CVE-2019-19781/CVE-2019-19781.nse

				https://blog.rapid7.com/2020/01/17/active-exploitation-of-citrix-netscaler-cve-2019-19781-what-you-need-to-know/


			Для последующих действий необходимо установить утилиту plocate
			для поиска расположения файлов:

				@ sudo pacman -S mlocate 
					
					[sudo] password for mwuckert:
					resolving dependencies...
					looking for conflicting packages...

					Packages (1) plocate-1.1.17-1

					Total Download Size:   0.13 MiB
					Total Installed Size:  0.49 MiB

					:: Proceed with installation? [Y/n] y
					:: Retrieving packages...
					 plocate-1.1.17-1-x86_64

				@ updatedb

				mwuckert@htb[/htb]$ locate scripts/citrix

				/usr/share/nmap/scripts/citrix-brute-xml.nse
				/usr/share/nmap/scripts/citrix-enum-apps-xml.nse
				/usr/share/nmap/scripts/citrix-enum-apps.nse
				/usr/share/nmap/scripts/citrix-enum-servers-xml.nse
				/usr/share/nmap/scripts/citrix-enum-servers.nse

	### Attacking Network Services
	Атака на сетевые службы
		
		# Banner Grabbing
		Захват баннера
			
			Как обсуждалось ранее, захват баннера — это полезный метод быстрого
			снятия отпечатков сервисов. Часто служба пытается идентифицировать
			себя, отображая баннер после установления соединения. Nmap
			попытается захватить баннеры, если синтаксис nmap -sV
			--script=banner <target>указано. Мы также можем попытаться сделать
			это вручную, используя Netcat. Возьмем другой пример, используя
			ncверсия Netcat:
				
				mwuckert@htb[/htb]$ nc -nv 10.129.42.253 21

				(UNKNOWN) [10.129.42.253] 21 (ftp) open
				220 (vsFTPd 3.0.3)

			Это свидетельствует о том, что версия vsFTPdна сервере есть 3.0.3.
			Мы также можем автоматизировать этот процесс, используя Nmap'sмощный
			скриптовый движок: nmap -sV --script=banner -p21 10.10.10.0/24. 			



	### FTP
		
		Стоит познакомиться с FTP, так как это стандартный протокол, и этот
		сервис часто может содержать интересные данные. А Nmapсканирование порта
		по умолчанию для FTP (21) показывает установку vsftpd 3.0.3, которую мы
		идентифицировали ранее. Кроме того, он также сообщает, что анонимная
		аутентификация включена и что pubкаталог доступен.

			mwuckert@htb[/htb]$ nmap -sC -sV -p21 10.129.42.253

				Starting Nmap 7.80 ( https://nmap.org ) at 2020-12-20 00:54 GMT
				Nmap scan report for 10.129.42.253
				Host is up (0.081s latency).

				PORT   STATE SERVICE VERSION
				21/tcp open  ftp     vsftpd 3.0.3
				| ftp-anon: Anonymous FTP login allowed (FTP code 230)
				|_drwxr-xr-x    2 ftp      ftp          4096 Dec 19 23:50 pub
				| ftp-syst: 
				|   STAT: 
				| FTP server status:
				|      Connected to ::ffff:10.10.14.2
				|      Logged in as ftp
				|      TYPE: ASCII
				|      No session bandwidth limit
				|      Session timeout in seconds is 300
				|      Control connection is plain text
				|      Data connections will be plain text
				|      At session startup, client count was 3
				|      vsFTPd 3.0.3 - secure, fast, stable
				|_End of status
				Service Info: OS: Unix

				Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
				Nmap done: 1 IP address (1 host up) scanned in 1.78 seconds			

		Подключимся к сервису с помощью ftpутилита командной строки.
			
			mwuckert@htb[/htb]$ ftp -p 10.129.42.253

			Connected to 10.129.42.253.
			220 (vsFTPd 3.0.3)
			Name (10.129.42.253:user): anonymous
			230 Login successful.
			Remote system type is UNIX.
			Using binary mode to transfer files.

			ftp> ls
			227 Entering Passive Mode (10,129,42,253,158,60).
			150 Here comes the directory listing.
			drwxr-xr-x    2 ftp      ftp          4096 Feb 25 19:25 pub
			226 Directory send OK.

			ftp> cd pub
			250 Directory successfully changed.

			ftp> ls
			227 Entering Passive Mode (10,129,42,253,182,129).
			150 Here comes the directory listing.
			-rw-r--r--    1 ftp      ftp            18 Feb 25 19:25 login.txt
			226 Directory send OK.

			ftp> get login.txt
			local: login.txt remote: login.txt
			227 Entering Passive Mode (10,129,42,253,181,53).
			150 Opening BINARY mode data connection for login.txt (18 bytes).
			226 Transfer complete.
			18 bytes received in 0.00 secs (165.8314 kB/s)

			ftp> exit
			221 Goodbye.

		В приведенной выше оболочке мы видим, что FTP поддерживает общие
		команды, такие как cdа также lsи позволяет нам загружать файлы с помощью
		getкоманда. Проверка загруженного login.txtраскрывает учетные данные,
		которые мы могли бы использовать для дальнейшего доступа к системе.
			
			mwuckert@htb[/htb]$ cat login.txt

			admin:ftp@dmin123

			

	### SMB
		
		SMB (Server Message Block) — это распространенный протокол на
		компьютерах с Windows, который предоставляет множество векторов для
		вертикального и горизонтального перемещения. Конфиденциальные данные,
		включая учетные данные, могут находиться в общих сетевых папках, а
		некоторые версии SMB могут быть уязвимы для эксплойтов RCE, таких как
		EternalBlue . 
			
			https://www.avast.com/c-eternalblue
		
		Крайне важно тщательно перечислить эту значительную потенциальную
		поверхность атаки. Nmapсодержит множество сценариев для перечисления
		SMB, таких как smb-os-discovery.nse , которые будут взаимодействовать со
		службой SMB для извлечения сообщаемой версии операционной системы.
			
			https://nmap.org/nsedoc/scripts/smb-os-discovery.html

			mwuckert@htb[/htb]$ nmap --script smb-os-discovery.nse -p445 10.10.10.40

			Starting Nmap 7.91 ( https://nmap.org ) at 2020-12-27 00:59 GMT
			Nmap scan report for doctors.htb (10.10.10.40)
			Host is up (0.022s latency).

			PORT    STATE SERVICE
			445/tcp open  microsoft-ds

			Host script results:
			| smb-os-discovery:
			|   OS: Windows 7 Professional 7601 Service Pack 1 (Windows 7 Professional 6.1)
			|   OS CPE: cpe:/o:microsoft:windows_7::sp1:professional
			|   Computer name: CEO-PC
			|   NetBIOS computer name: CEO-PC\x00
			|   Workgroup: WORKGROUP\x00
			|_  System time: 2020-12-27T00:59:46+00:00

			Nmap done: 1 IP address (1 host up) scanned in 2.71 seconds
		
		В этом случае хост работает под управлением устаревшей ОС Windows 7, и
		мы могли бы провести дальнейшее перечисление, чтобы подтвердить, уязвим
		ли он для EternalBlue. В Metasploit Framework есть несколько модулей для
		EternalBlue, которые можно использовать для проверки уязвимости и ее
		использования, как мы увидим в следующем разделе. 
			
			https://www.rapid7.com/db/modules/exploit/windows/smb/ms17_010_eternalblue/			

		Мы можем запустить сканирование нашей цели для этого раздела модуля,
		чтобы собрать информацию из службы SMB. Мы можем установить, что на
		хосте работает ядро Linux, версия Samba 4.6.2, а имя хоста — GS-SVCSCAN. 
			
			mwuckert@htb[/htb]$ nmap -A -p445 10.129.42.253

			Starting Nmap 7.80 ( https://nmap.org ) at 2021-02-25 16:29 EST
			Nmap scan report for 10.129.42.253
			Host is up (0.11s latency).

			PORT    STATE SERVICE     VERSION
			445/tcp open  netbios-ssn Samba smbd 4.6.2
			Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
			Aggressive OS guesses: Linux 2.6.32 (95%), Linux 3.1 (95%), Linux 3.2 (95%), AXIS 210A or 211 Network Camera (Linux 2.6.17) (94%), ASUS RT-N56U WAP (Linux 3.4) (93%), Linux 3.16 (93%), Adtran 424RG FTTH gateway (92%), Linux 2.6.39 - 3.2 (92%), Linux 3.1 - 3.2 (92%), Linux 3.2 - 4.9 (92%)
			No exact OS matches for host (test conditions non-ideal).
			Network Distance: 2 hops

			Host script results:
			|_nbstat: NetBIOS name: GS-SVCSCAN, NetBIOS user: <unknown>, NetBIOS MAC: <unknown> (unknown)
			| smb2-security-mode:
			|   2.02:
			|_    Message signing enabled but not required
			| smb2-time:
			|   date: 2021-02-25T21:30:06
			|_  start_date: N/A

			TRACEROUTE (using port 445/tcp)
			HOP RTT       ADDRESS
			1   111.62 ms 10.10.14.1
			2   111.89 ms 10.129.42.253

			OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
			Nmap done: 1 IP address (1 host up) scanned in 12.72 seconds

	### Shares
	Акции 	
		
		SMB позволяет пользователям и администраторам совместно использовать
		папки и делать их удаленно доступными для других пользователей. Часто в
		этих общих ресурсах есть файлы, содержащие конфиденциальную информацию,
		например пароли. Инструмент, который может перечислять общие ресурсы SMB
		и взаимодействовать с ними, называется smbclient . 
			
			https://www.samba.org/samba/docs/current/man-html/smbclient.1.html

		-L флаг указывает, что мы хотим получить список доступных общих ресурсов
		на удаленном хосте, в то время как -Nподавляет запрос пароля. 		
			
			mwuckert@htb[/htb]$ smbclient -N -L \\\\10.129.42.253

			Sharename       Type      Comment
			---------       ----      -------
			print$          Disk      Printer Drivers
			users           Disk
			IPC$            IPC       IPC Service (gs-svcscan server (Samba, Ubuntu))
			SMB1 disabled -- no workgroup available

		Это показывает нестандартную долю users. Давайте попробуем подключиться как гость.
			
			mwuckert@htb[/htb]$ smbclient \\\\10.129.42.253\\users

			Enter WORKGROUP\users's password:
			Try "help" to get a list of possible commands.

			smb: \> ls
			NT_STATUS_ACCESS_DENIED listing \*

			smb: \> exit


		The lsКоманда привела к сообщению об отказе в доступе, указывающему, что
		гостевой доступ не разрешен. Давайте попробуем еще раз, используя
		учетные данные для пользователя bob ( bob:Welcome1).
			
			mwuckert@htb[/htb]$ smbclient -U bob \\\\10.129.42.253\\users

			Enter WORKGROUP\bob's password:
			Try "help" to get a list of possible commands.

			smb: \> ls
			  .                                   D        0  Thu Feb 25 16:42:23 2021
			  ..                                  D        0  Thu Feb 25 15:05:31 2021
			  bob                                 D        0  Thu Feb 25 16:42:23 2021

					4062912 blocks of size 1024. 1332480 blocks available

			smb: \> cd bob

			smb: \bob\> ls
			  .                                   D        0  Thu Feb 25 16:42:23 2021
			  ..                                  D        0  Thu Feb 25 16:42:23 2021
			  passwords.txt                       N      156  Thu Feb 25 16:42:23 2021

					4062912 blocks of size 1024. 1332480 blocks available

			smb: \bob\> get passwords.txt
			getting file \bob\passwords.txt of size 156 as passwords.txt (0.3 KiloBytes/sec) (average 0.3 KiloBytes/sec)

		Мы успешно получили доступ к usersподелиться с использованием учетных
		данных и получить доступ к интересному файлу passwords.txt, который
		можно скачать с getкоманда.



	### SNMP
		
		Строки сообщества SNMP предоставляют информацию и статистику о
		маршрутизаторе или устройстве, помогая нам получить к ним доступ. Строки
		сообщества производителя по умолчанию publicа также privateчасто
		неизменны. В версиях 1 и 2c SNMP доступ контролируется с помощью
		текстовой строки сообщества, и если мы знаем имя, мы можем получить к
		нему доступ. Шифрование и аутентификация были добавлены только в SNMP
		версии 3. С помощью SNMP можно получить много информации. Проверка
		параметров процесса может выявить учетные данные, переданные в командной
		строке, которые можно повторно использовать для других служб, доступных
		извне, учитывая преобладание повторного использования паролей в
		корпоративных средах. Также может быть раскрыта маршрутная информация,
		службы, привязанные к дополнительным интерфейсам, и версия
		установленного программного обеспечения.
			
			mwuckert@htb[/htb]$ snmpwalk -v 2c -c public 10.129.42.253 1.3.6.1.2.1.1.5.0

				iso.3.6.1.2.1.1.5.0 = STRING: "gs-svcscan"

			mwuckert@htb[/htb]$ snmpwalk -v 2c -c private  10.129.42.253 

				Timeout: No Response from 10.129.42.253

		Такой инструмент, как onextyone , можно использовать для перебора имен
		строк сообщества с использованием файла словаря общих строк сообщества,
		такого как dict.txtфайл, включенный в репозиторий GitHub для
		инструмента.
			
			https://github.com/trailofbits/onesixtyone

			mwuckert@htb[/htb]$ onesixtyone -c dict.txt 10.129.42.254

				Scanning 1 hosts, 51 communities
				10.129.42.254 [public] Linux gs-svcscan 5.4.0-66-generic #74-Ubuntu SMP Wed Jan 27 22:54:38 UTC 2021 x86_64




	### Conclusion
	Вывод
		
		Сканирование и перечисление сервисов — обширная тема, о которой мы
		узнаем больше по ходу дела. Аспекты, которые мы рассмотрели здесь,
		применимы ко многим сетям, включая машины HTB.


QUESTIONS:
	



